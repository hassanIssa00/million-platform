rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================================
    // HELPER FUNCTIONS
    // =====================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Check if user is teacher
    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }
    
    // Check if user is student
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }
    
    // Check if user is parent
    function isParent() {
      return isAuthenticated() && getUserRole() == 'parent';
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if teacher teaches the class
    function teachesClass(classId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/classes/$(classId)) &&
             get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
    }
    
    // Check if student is enrolled in class
    function isEnrolledInClass(classId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + classId));
    }
    
    // Check if user is parent of student
    function isParentOf(studentId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/parentStudents/$(request.auth.uid + '_' + studentId));
    }
    
    // =====================================================
    // USERS COLLECTION
    // =====================================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can update their own profile (except role)
      allow update: if isOwner(userId) && 
                       request.resource.data.role == resource.data.role;
      
      // Only admins can create/delete users
      allow create, delete: if isAdmin();
      
      // Teachers can read their students
      allow read: if isTeacher() && 
                     resource.data.role == 'student' &&
                     exists(/databases/$(database)/documents/enrollments/$(userId + '_'));
      
      // Parents can read their children
      allow read: if isParentOf(userId);
    }
    
    // =====================================================
    // SCHOOLS COLLECTION
    // =====================================================
    match /schools/{schoolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // =====================================================
    // CLASSES COLLECTION
    // =====================================================
    match /classes/{classId} {
      // Students can read classes they're enrolled in
      allow read: if isEnrolledInClass(classId);
      
      // Teachers can read/update their classes
      allow read, update: if teachesClass(classId);
      
      // Admins can do everything
      allow read, write: if isAdmin();
    }
    
    // =====================================================
    // SUBJECTS COLLECTION
    // =====================================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // =====================================================
    // ENROLLMENTS COLLECTION
    // =====================================================
    match /enrollments/{enrollmentId} {
      // Students can read their own enrollments
      allow read: if resource.data.studentId == request.auth.uid;
      
      // Teachers can read enrollments in their classes
      allow read: if teachesClass(resource.data.classId);
      
      // Parents can read their children's enrollments
      allow read: if isParentOf(resource.data.studentId);
      
      // Admins can manage enrollments
      allow write: if isAdmin();
    }
    
    // =====================================================
    // PARENT-STUDENT RELATIONSHIPS
    // =====================================================
    match /parentStudents/{relationshipId} {
      allow read: if resource.data.parentId == request.auth.uid ||
                     resource.data.studentId == request.auth.uid ||
                     isAdmin();
      allow write: if isAdmin();
    }
    
    // =====================================================
    // ASSIGNMENTS COLLECTION
    // =====================================================
    match /assignments/{assignmentId} {
      // Students can read published assignments in their classes
      allow read: if resource.data.status == 'published' && 
                     isEnrolledInClass(resource.data.classId);
      
      // Teachers can manage their own assignments
      allow read, write: if resource.data.teacherId == request.auth.uid;
      
      // Admins can read all assignments
      allow read: if isAdmin();
    }
    
    // =====================================================
    // SUBMISSIONS COLLECTION
    // =====================================================
    match /submissions/{submissionId} {
      // Students can read/create/update their own submissions
      allow read, create: if resource.data.studentId == request.auth.uid;
      allow update: if resource.data.studentId == request.auth.uid &&
                       resource.data.status == 'pending'; // Can't update after grading
      
      // Teachers can read/grade submissions for their assignments
      allow read, update: if exists(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)) &&
                             get(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)).data.teacherId == request.auth.uid;
      
      // Parents can read their children's submissions
      allow read: if isParentOf(resource.data.studentId);
      
      // Admins can read all
      allow read: if isAdmin();
    }
    
    // =====================================================
    // GRADES COLLECTION
    // =====================================================
    match /grades/{gradeId} {
      // Students can read their own grades
      allow read: if resource.data.studentId == request.auth.uid;
      
      // Parents can read their children's grades
      allow read: if isParentOf(resource.data.studentId);
      
      // Teachers can read/write grades for their classes
      allow read, write: if teachesClass(resource.data.classId);
      
      // Admins can read all grades
      allow read: if isAdmin();
    }
    
    // =====================================================
    // ATTENDANCE COLLECTION
    // =====================================================
    match /attendance/{attendanceId} {
      // Students can read their own attendance
      allow read: if resource.data.studentId == request.auth.uid;
      
      // Parents can read their children's attendance
      allow read: if isParentOf(resource.data.studentId);
      
      // Teachers can manage attendance for their classes
      allow read, write: if teachesClass(resource.data.classId);
      
      // Admins can read all
      allow read: if isAdmin();
    }
    
    // =====================================================
    // PAYMENTS COLLECTION
    // =====================================================
    match /payments/{paymentId} {
      // Students can read their own payments
      allow read: if resource.data.studentId == request.auth.uid;
      
      // Parents can read/update their children's payments
      allow read, update: if isParentOf(resource.data.studentId) ||
                             resource.data.parentId == request.auth.uid;
      
      // Admins can manage all payments
      allow read, write: if isAdmin();
    }
    
    // =====================================================
    // NOTIFICATIONS COLLECTION
    // =====================================================
    match /notifications/{notificationId} {
      // Users can read/update their own notifications
      allow read, update: if resource.data.userId == request.auth.uid;
      
      // System can create notifications (via Cloud Functions)
      allow create: if true;
    }
    
    // =====================================================
    // MESSAGES COLLECTION
    // =====================================================
    match /messages/{messageId} {
      // Users can read messages in classes they're part of
      allow read: if isEnrolledInClass(resource.data.classId) ||
                     teachesClass(resource.data.classId);
      
      // Teachers can create announcements
      allow create: if teachesClass(request.resource.data.classId) &&
                       request.resource.data.senderId == request.auth.uid;
      
      // Students can create regular messages (not announcements)
      allow create: if isEnrolledInClass(request.resource.data.classId) &&
                       request.resource.data.senderId == request.auth.uid &&
                       request.resource.data.isAnnouncement == false;
    }
    
    // =====================================================
    // AUDIT LOGS COLLECTION
    // =====================================================
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // System can create logs (via Cloud Functions)
      allow create: if true;
    }
  }
}
